# Fieldstack CSV 금융 데이터 업로드 & 처리 설계 (국내 + 해외)

> 본 문서는 Fieldstack 프로젝트에서 **금융 데이터(CSV) 업로드 및 처리 기능**을 설계하기 위한 기준 문서이다.
> 본 설계는 **한국뿐 아니라 해외 금융 CSV 포맷까지 확장 가능**하도록 구성되며,
> 금융 API 직접 연동 없이 **CSV 기반 입력을 1급 기능**으로 취급한다.

---

## 1. 설계 목표

### 1.1 기본 원칙
- 금융 API, 마이데이터, 실시간 연동을 **직접 제공하지 않는다**
- 사용자가 **직접 다운로드한 CSV 파일**만을 입력으로 사용한다
- CSV 업로드는 임시 수단이 아닌 **정식 입력 방식**이다
- 오픈소스 환경에서도 **법적·보안 리스크가 없는 구조**를 유지한다

### 1.2 지원 범위
- 한국 은행 / 카드 CSV
- 해외 은행 / 카드 CSV
- 다중 통화
- 다양한 날짜/시간 포맷
- 제공자별 CSV 포맷 확장

---

## 2. 전체 처리 흐름

1. 사용자 CSV 업로드
2. 파일 인코딩 자동 감지 (UTF-8 / EUC-KR 등)
3. CSV 헤더 및 데이터 패턴 분석
4. 제공자 포맷 자동 추정
5. 내부 표준 Transaction 모델로 변환
6. 중복 데이터 검증
7. 사용자 확인 후 등록

---

## 3. CSV 입력 정책

### 3.1 허용 방식
- 웹 업로드
- 드래그 앤 드롭
- 데스크탑 앱(선택): 로컬 폴더 감시

### 3.2 금지 방식
- 은행 사이트 자동 로그인
- 스크래핑 / 크롤링
- 외부 서비스 계정 연동

---

## 4. 내부 표준 데이터 모델

### 4.1 Transaction 모델 (Core)

```ts
Transaction {
  id: string
  source: 'csv'
  provider?: string          // KB, Shinhan, Chase, AMEX 등
  country?: string           // KR, US, JP ... (ISO 3166)

  accountId?: string
  date: string               // 원본 날짜 문자열
  timezone?: string

  amount: number
  currency: string           // ISO 4217 (KRW, USD, JPY 등)

  type: 'income' | 'expense' | 'transfer' | 'fee' | 'refund'
  description?: string

  rawData: Record<string, any> // 원본 CSV row 보존
}
```

### 4.2 설계 원칙
- 환율 변환은 수행하지 않는다
- 금액과 통화는 분리 저장한다
- 원본 데이터는 항상 보존한다

---

## 5. CSV 자동 판별 전략

### 5.1 판별 기준
- 헤더 이름
- 컬럼 개수
- 날짜 포맷
- 금액 표현 방식

### 5.2 국가 기반이 아닌 **패턴 기반 판별**

> CSV는 국가가 아니라 **제공자 포맷 단위**로 인식한다.

---

## 6. 매핑 전략

### 6.1 자동 매핑
- 날짜 컬럼 추정
- 금액 컬럼 추정
- 입금/출금 방향 추론

### 6.2 사용자 확인
- 최초 업로드 시 매핑 확인 UI 제공
- 매핑 설정은 저장되어 재사용 가능

---

## 7. 중복 데이터 처리

### 7.1 중복 판단 기준
- (date + amount + description + accountId) 조합
- 또는 CSV row 해시

### 7.2 동작 정책
- 이미 등록된 거래는 자동 스킵
- 스킵된 개수 사용자에게 표시

---

## 8. 국가 및 제공자 확장 구조

```text
csv/
 ├─ kr/
 │   ├─ kb-bank.ts
 │   ├─ shinhan-card.ts
 │
 ├─ us/
 │   ├─ chase-bank.ts
 │   ├─ amex-card.ts
 │
 └─ jp/
     └─ mufg-bank.ts
```

- 국가 폴더는 분류용
- 실제 로직은 제공자 단위로 관리

---

## 9. UX 고려 사항

- 업로드 후 미리보기 제공
- 처리 결과 요약 표시
  - 총 거래 수
  - 신규 등록
  - 중복 스킵
- 오류 발생 시 row 단위 안내

---

## 10. 법적 및 책임 범위 명시 (README 권장 문구)

> 본 프로젝트는 금융 기관과 직접 연동하지 않으며,
> 사용자가 제공한 CSV 파일을 기반으로 데이터를 정리·관리하는 도구입니다.
> 금융 데이터의 수집 및 사용에 대한 책임은 사용자에게 있습니다.

---

## 11. 향후 확장 가능성

- 기업 전용 금융 API 어댑터
- 자동 분류 규칙
- 태그 / 카테고리 시스템
- 환율 정보 연계 (선택)

---

## 12. 핵심 설계 철학

> **CSV는 불편함의 대체재가 아니라,
> 신뢰 가능한 금융 데이터 입력 방식이다.**

이 문서는 Fieldstack의 금융 데이터 처리 방향을 고정하는 기준 문서로 사용된다.