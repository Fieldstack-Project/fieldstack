# 웹 기반 설치 마법사

## 개요

시놀로지 NAS와 같은 직관적인 웹 기반 설치 마법사를 제공하여, 명령줄 없이도 쉽게 설치할 수 있도록 합니다.

> **UX 레퍼런스 (향후 소개 문서/공식 페이지 작성 시 참고):**
> "Ubuntu와 Synology 설치 마법사를 합친 경험"
>
> - **Ubuntu의 장점** — 내 환경에 직접 설치하는 자유도, 단계별 진행감
> - **Synology의 장점** — 브라우저에서 전부 해결, 전문 지식 불필요
> - **Ubuntu의 단점** (터미널, 전문 지식 요구) → 제거
> - **Synology의 단점** (전용 하드웨어 종속, 고가) → 제거

## 설치 플로우

```
1. 프로젝트 다운로드/클론
   ↓
2. Docker Compose / npm install (기본만)
   ↓
3. 서버 실행 → 웹 브라우저 자동 열림
   ↓
4. 웹 설정 마법사 (모든 설정 여기서)
   ↓
5. "설치 시작" 버튼 클릭
   ↓
6. 백그라운드에서:
   - DB 마이그레이션
   - 의존성 설치
   - 모듈 초기화
   - 관리자 계정 생성
   ↓
7. 완료 → 로그인 화면
```

## 화면 구성

### 1. 시작 화면 (Welcome)

```
┌─────────────────────────────────────┐
│                                     │
│        🏦 Fieldstack                │
│                                     │
│   개인용 금융 & 생산성 관리 시스템    │
│                                     │
│   이 마법사를 통해 5분 안에           │
│   시스템을 설정할 수 있습니다.        │
│                                     │
│   📋 시스템 요구사항                 │
│   • Node.js 20+                     │
│   • 500MB RAM                       │
│   • 1GB Storage                     │
│                                     │
│   ⏱️ 예상 소요 시간: 10-15분         │
│                                     │
│            [시작하기 →]              │
│                                     │
└─────────────────────────────────────┘
```

### 2. 설정 입력 화면 (Configuration)

#### 2.1 관리자 계정 (필수)

```
┌─────────────────────────────────────┐
│ 1️⃣ 관리자 계정                       │
├─────────────────────────────────────┤
│                                     │
│ 이름:                                │
│ [                    ]              │
│                                     │
│ 이메일:                              │
│ [                    ]              │
│                                     │
│ 비밀번호:                            │
│ [                    ]              │
│ ※ 최소 8자, 영문+숫자 조합           │
│                                     │
│ 비밀번호 확인:                       │
│ [                    ]              │
│                                     │
└─────────────────────────────────────┘
```

#### 2.2 데이터베이스 (필수)

```
┌─────────────────────────────────────┐
│ 2️⃣ 데이터베이스                      │
├─────────────────────────────────────┤
│                                     │
│ ( ) SQLite (권장)                   │
│     • 설정 불필요, 자동 설치            │
│     • 파일 기반, 간단한 백업            │
│                                     │
│ ( ) PostgreSQL                      │
│     • 고성능, 대용량 처리               │
│     • 별도 설치 필요                   │
│                                     │
│ ( ) Supabase                        │
│     • 클라우드 DB, 무료 티어            │
│     • 자동 백업, 확장 용이              │
│                                     │
│ [SQLite 선택 시]                     │
│ 저장 경로: ./data/database.db       │
│                                     │
│ [PostgreSQL 선택 시]                │
│ 호스트: [localhost    ]             │
│ 포트:   [5432         ]             │
│ DB명:   [finance      ]             │
│ 사용자: [finance      ]             │
│ 비밀번호:[             ]             │
│ [연결 테스트]                        │
│                                     │
│ [Supabase 선택 시]                  │
│ Project URL:                        │
│ [https://xxx.supabase.co]           │
│ API Key:                            │
│ [                       ]           │
│ [연결 테스트]                        │
│                                     │
└─────────────────────────────────────┘
```

#### 2.3 AI 기능 (선택)

```
┌─────────────────────────────────────┐
│ 3️⃣ AI 기능 (선택)                    │
├─────────────────────────────────────┤
│                                     │
│ [ ] AI 기능 활성화                   │
│                                     │
│ Provider:                           │
│ ( ) Google Gemini (무료 티어)        │
│ ( ) OpenAI                          │
│ ( ) Anthropic Claude                │
│ ( ) Ollama (로컬)                   │
│                                     │
│ API Key:                            │
│ [                       ]           │
│                                     │
│ 💡 API Key 발급 방법:                │
│ • Gemini: https://makersuite...    │
│ • OpenAI: https://platform...      │
│ • Claude: https://console...       │
│                                     │
│ [건너뛰기]                           │
│                                     │
└─────────────────────────────────────┘
```

#### 2.4 Google 연동 (선택)

```
┌─────────────────────────────────────┐
│ 4️⃣ Google 연동 (선택)                │
├─────────────────────────────────────┤
│                                     │
│ [ ] Google 서비스 연동               │
│                                     │
│ OAuth Client ID:                    │
│ [                       ]           │
│                                     │
│ OAuth Client Secret:                │
│ [                       ]           │
│                                     │
│ 💡 OAuth 설정 방법:                  │
│ 1. Google Cloud Console 접속        │
│ 2. OAuth 2.0 클라이언트 ID 생성       │
│ 3. 리다이렉트 URI 등록:               │
│    http://localhost:3000/auth/...  │
│                                     │
│ [📖 자세한 가이드]                   │
│ [건너뛰기]                           │
│                                     │
└─────────────────────────────────────┘
```

#### 2.5 모듈 선택 (선택)

```
┌─────────────────────────────────────┐
│ 5️⃣ 설치할 모듈 선택                  │
├─────────────────────────────────────┤
│                                     │
│ 권장 모듈:                           │
│ [✓] 💰 가계부                       │
│     수입과 지출 관리                  │
│                                     │
│ [✓] 📅 구독 관리                    │
│     정기 구독 서비스 추적              │
│                                     │
│ 추가 모듈:                           │
│ [ ] ✅ TODO                         │
│     할 일 관리                        │
│                                     │
│ [ ] 📊 프로젝트 관리                 │
│     외주 및 프로젝트 추적              │
│                                     │
│ 💡 나중에 마켓플레이스에서             │
│    추가 모듈을 설치할 수 있습니다.      │
│                                     │
│ [모두 건너뛰기]                       │
│ ※ 건너뛰면 튜토리얼 화면이 표시됩니다   │
│                                     │
└─────────────────────────────────────┘
```

### 3. 설치 진행 화면 (Progress)

```
┌─────────────────────────────────────┐
│ 설치 중...                           │
├─────────────────────────────────────┤
│                                     │
│ [████████████████░░░░] 80%          │
│                                     │
│ 현재 단계: DB 마이그레이션 중...       │
│                                     │
│ ✅ 1. 설정 검증 완료                 │
│ ✅ 2. 데이터베이스 연결 완료          │
│ ✅ 3. 데이터베이스 마이그레이션 완료   │
│ ⏳ 4. 의존성 설치 중...              │
│ ⬜ 5. 모듈 다운로드 및 설치           │
│ ⬜ 6. 관리자 계정 생성                │
│ ⬜ 7. 최종 설정                      │
│                                     │
│ 📋 설치 로그:                        │
│ ┌─────────────────────────────────┐ │
│ │ [INFO] DB 연결 성공...           │ │
│ │ [INFO] 테이블 생성 중...          │ │
│ │ [INFO] ledger_entries 생성 완료  │ │
│ │ [INFO] npm install 실행 중...    │ │
│ │ ...                             │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ※ 이 과정은 5-10분 정도 소요됩니다.    │
│                                     │
└─────────────────────────────────────┘
```

### 4. 완료 화면 (Complete)

```
┌─────────────────────────────────────┐
│                                     │
│            🎉 설치 완료!            │
│                                     │
│   Fieldstack이 성공적으로            │
│   설치되었습니다!                    │
│                                     │
│ 📦 설치된 항목:                     │
│ ✅ 데이터베이스 (SQLite)            │
│ ✅ 관리자 계정 (admin@example.com)  │
│ ✅ 모듈: 가계부, 구독 관리           │
│                                     │
│ 🚀 다음 단계:                       │
│ 1. 로그인하여 시작하기                │
│ 2. 마켓플레이스에서 추가 모듈 탐색    │
│ 3. 설정에서 Google 연동 (선택)       │
│                                     │
│ 📚 유용한 링크:                     │
│ • 사용자 가이드                      │
│ • 튜토리얼 영상                      │
│ • 커뮤니티 (Discord)                 │
│                                     │
│         [로그인하러 가기 →]           │
│                                     │
└─────────────────────────────────────┘
```

## Backend 구현

### 설치 API

`apps/api/src/routes/install.ts`에 세 가지 라우트가 정의됩니다.

**`POST /start`** — 설치를 시작합니다. 요청본문의 설정 객체를 받아 `runInstallation`을 호출하며, WebSocket을 통해 각 단계의 진행 상황(단계 번호, 퍼센트, 메시지, 타임스탬프)을 실시간으로 클라이언트에 전송합니다. 설치 완료 시 성공 응답을 반환하고, 실패 시 오류 메시지와 실패 단계를 반환합니다.

**`GET /status`** — 현재 설치 완료 여부를 조회합니다. `checkInstallation`의 결과를 `{ installed: boolean }` 형태로 반환합니다.

**`POST /test-db`** — 요청본문의 provider와 설정 정보를 받아 데이터베이스 연결을 테스트합니다. 성공 시 `{ success: true }`, 실패 시 400 상태와 연결 실패 메시지를 반환합니다.

### 설치 서비스

`apps/api/src/services/installer.ts`의 `runInstallation` 함수는 설치 전체 과정을 단계별로 실행합니다. 각 단계마다 콜백을 통해 진행율을 보고합니다.

**1단계 — 설정 검증 (10%):** `validateConfig`를 호출하여 관리자 이메일 형식, 비밀번호 길이(최소 8자), 데이터베이스 provider 유무를 확인합니다.

**2단계 — 데이터베이스 연결 (20%):** `connectDatabase`를 호출하여 provider 종류에 따라 SQLite, PostgreSQL, Supabase 중 하나의 설정 함수를 실행합니다.

**3단계 — DB 마이그레이션 (40%):** `runMigrations`로 테이블 스키마를 생성합니다.

**4단계 — 의존성 설치 (60%):** `installDependencies`로 모듈 등의 의존성을 설치합니다.

**5단계 — 모듈 설치 (70%):** 설정에서 선택된 모듈 목록이 있으면 각 모듈을 순회하며 `installModule`을 호출합니다.

**6단계 — 관리자 계정 생성 (85%):** `createAdminAccount`를 호출합니다. 비밀번호를 bcrypt으로 해싱하여 `allowedUsers` 테이블에 admin 역할로 저장합니다.

**7단계 — 최종 설정 (95%):** `finalizeInstallation`으로 마지막 설정을 적용합니다.

**8단계 — 완료 (100%):** `setInstalled`를 호출하여 `.env` 파일의 `FIRST_RUN`을 `'false'`로 업데이트하고, `.installed` 파일에 현재 시간을 기록합니다.

오류가 발생하면 오류 메시지와 실패 단계를 포함하여 throw합니다.

## Frontend 구현

### 설치 마법사 컴포넌트

`apps/web/src/pages/Install/index.tsx`의 `Install` 컴포넌트는 `step` 상태로 현재 단계를 관리합니다. 단계별로 다음 컴포넌트를 조건부 렌더링합니다: 1단계는 Welcome, 2단계는 Configuration, 3단계는 Progress, 4단계는 Complete입니다.

Welcome에서 시작하기를 누르면 2단계로 이동합니다. Configuration에서 폼을 제출하면 설정 객체를 저장하고 3단계(Progress)로 전환되며, `/api/install/start`에 POST 요청을 보냅니다. 설치가 완료되면 4단계(Complete)로 이동합니다. 오류가 발생하면 알림을 표시하고 2단계로 돌아감합니다. Complete에서 완료 버튼을 누르면 `/login`으로 네비게이트합니다.

### WebSocket 진행 상황

`apps/web/src/pages/Install/Progress.tsx`는 Socket.IO를 사용하여 백엔드와 실시간 통신합니다. 컴포넌트가 마운트되면 소켓 연결을 생성하고 `install:progress` 이벤트를 구독합니다. 이벤트가 발생하면 퍼센트, 현재 단계 메시지, 로그 목록 상태를 업데이트합니다. 컴포넌트가 언마운트되면 소켓을 해제합니다. 렌더링 시에는 퍼센트에 맞게 width가 변하는 프로그레스 바, 현재 진행 단계 텍스트, 시간대와 메시지가 포함된 로그 목록을 표시합니다.

## 첫 실행 감지

`apps/api/src/index.ts`에서 서버 시작 시 `FIRST_RUN` 환경 변수가 `'true'`이거나 `.installed` 파일이 존재하지 않으면 첫 실행으로 판단합니다. 첫 실행 시에는 설치 마법사 라우트(`/api/install`)만 활성화되고, 그 외 모든 요청은 `/install` 페이지로 리다이렉트됩니다. 설치가 완료된 후에는 일반 API 라우트가 활성화됩니다.