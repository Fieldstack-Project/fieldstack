# AI 통합 정책

## 개요

AI는 계산 주체가 아닌 **분석/요약/해설 역할**로만 사용됩니다.

### AI 사용 예시

**✅ 적절한 사용:**
- 월간 가계부 요약 및 분석
- 지출 패턴 해설
- 예산 조언
- 구독 서비스 최적화 제안
- 영수증 OCR 및 자동 분류

**❌ 부적절한 사용:**
- 금액 계산 (직접 연산)
- 데이터 생성/수정
- 자동 거래 실행
- 투자 결정

---

## 지원 Provider

### 1. Google Gemini

Provider를 'gemini'로 설정하고, 사용 가능한 모델으로 gemini-pro와 gemini-pro-vision이 있습니다. 지원하는 기능은 텍스트, 이미지, 멀티모달입니다.

**장점:**
- 무료 티어 제공
- 멀티모달 (텍스트 + 이미지)
- 빠른 응답

### 2. OpenAI

Provider를 'openai'로 설정하고, 사용 가능한 모델으로 gpt-4, gpt-4-turbo, gpt-3.5-turbo가 있습니다. 지원하는 기능은 텍스트와 함수 호출(Function Calling)입니다.

**장점:**
- 고품질 응답
- Function Calling 지원
- 안정적

### 3. Anthropic Claude

Provider를 'anthropic'로 설정하고, 사용 가능한 모델으로 claude-3-opus, claude-3-sonnet, claude-3-haiku가 있습니다. 지원하는 기능은 텍스트와 긴 컨텍스트 처리입니다.

**장점:**
- 긴 컨텍스트
- 정확한 분석
- 안전성

### 4. Ollama (로컬)

Provider를 'ollama'로 설정하고, 사용 가능한 모델으로 llama2, mistral, codellama가 있습니다. 지원하는 기능은 텍스트와 로컬 실행입니다.

**장점:**
- 완전 무료
- 프라이버시
- 오프라인 사용

---

## 설정

### 환경 변수

AI_PROVIDER에 사용할 Provider 이름을 넣고, AI_API_KEY에 해당 Provider의 API 키를 넣고, AI_MODEL에 사용할 모델 이름을 넣습니다.

### 웹 UI 설정

**설정 → AI:**
1. Provider 선택
2. API Key 입력
3. 모델 선택
4. 연결 테스트
5. 저장

---

## AI 추상화 레이어

### 인터페이스

AI Provider가 공통으로 제공해야 할 세 가지 기능을 정의합니다. 첫째는 generate로, 프롬프트를 받아 텍스트 응답을 생성합니다. 둘째는 generateStream으로, 응답을 청크 단위로 실시간으로 흘려보내는 스트리밍 생성입니다. 셋째는 analyzeImage로, 이미지와 프롬프트를 받아 이미지를 분석합니다.

GenerateOptions는 응답의 창의성을 조절하는 temperature, 최대 응답 길이인 maxTokens, 그리고 시스템 수준의 지침인 systemPrompt를 설정할 수 있습니다.

### Provider 구현

Gemini Provider의 구현을 예시로 보여줍니다. 클래스를 초기화할 때 API 키와 모델 이름을 받아 저장합니다.

generate 메서드는 주어진 프롬프트를 Gemini API에 전송하여 텍스트 응답을 받아 반환합니다. 이때 temperature와 maxTokens 옵션을 적용하며, 기본값은 각각 0.7과 1000입니다.

generateStream 메서드는 동일하게 프롬프트를 전송하지만, 응답을 청크 단위로 실시간으로 받아 하나씩 반환합니다.

analyzeImage 메서드는 이미지를 Base64로 변환하여 프롬프트와 함께 gemini-pro-vision 모델에 전송하고, 분석 결과를 텍스트로 반환합니다.

### Provider 팩토리

사용자 ID를 받아 해당 사용자의 AI 설정을 조회합니다. Provider가 설정되지 않았거나 'none'이면 에러를 발생시킵니다. 설정된 Provider 이름에 따라 Gemini, OpenAI, Anthropic, Ollama 중 하나의 Provider 객체를 생성하여 반환합니다. 알 수 없는 Provider 이름이면 에러를 발생시킵니다.

---

## 사용 예시

### 1. 월간 가계부 요약

총 세 단계로 진행됩니다. 첫째로 해당 사용자의 해당 월간 가계부 항목을 데이터베이스에서 조회합니다. 둘째로 조회된 항목들로 총 수입, 총 지출, 순액, 카테고리별 지출 등의 통계를 계산합니다. 셋째로 AI Provider를 생성하고, 계산된 통계를 프롬프트로 넘기여 주요 지출 패턴, 절약 가능한 부분, 다음 달 예산 제안을 한국어로 작성하는 것을 요청합니다. 이때 temperature는 0.7, maxTokens는 500으로 설정합니다.

### 2. 영수증 분석 (OCR)

사용자의 AI Provider를 생성한 후, 영수증 이미지를 전달하며 상호명, 총 금액, 결제 일시, 구매 항목들을 JSON 형식으로 추출하는 것을 요청합니다. AI가 반환한 응답을 JSON으로 파싱하여 반환합니다.

### 3. 지출 패턴 분석

최근 90일간의 지출 항목을 조회한 후, AI Provider를 생성하여 해당 데이터를 프롬프트로 넘기고 반복적인 지출 패턴, 비정상적인 지출, 절약 팁을 3~5문장으로 간결하게 분석하는 것을 요청합니다.

### 4. 구독 최적화 제안

해당 사용자의 구독 목록을 전체 조회한 후, 서비스명과 월간 금액을 정리하여 총 구독료와 함께 AI에 전달합니다. 중복된 서비스, 사용하지 않을 것 같은 서비스, 대체 가능한 저렴한 옵션을 3~4문장으로 간결하게 제안하는 것을 요청합니다.

---

## 스트리밍 응답

### Backend

API 엔드포인트를 POST /api/ai/analyze로 생성합니다. 요청이 들어오면 응답의 Content-Type을 text/event-stream으로 설정하여 실시간 스트리밍을 준비합니다. 사용자의 AI Provider를 생성한 후 generateStream을 호출하며, 응답이 청크 단위로 날아올 때마다 SSE(Server-Sent Events) 형식으로 클라이언트에 전송합니다. 스트리밍이 완료되면 [DONE] 신호를 보내고, 에러가 발생하면 에러 메시지를 전송합니다.

### Frontend

useAIStream이라는 훅을 생성합니다. 이 훅은 현재까지 받은 텍스트와 로딩 상태를 관리합니다. generate 함수를 호출하면 백엔드의 스트리밍 엔드포인트에 요청을 보내고, 응답 본문을 ReadableStream으로 읽습니다. 청크가 날아올 때마다 SSE 형식을 파싱하여 텍스트를 누적하며 표시하고, [DONE] 신호를 받으면 로딩 상태를 끕니다.

---

## 비용 관리

### 사용량 추적

AIUsageTracker 클래스를 구현합니다. track 메서드는 사용자 ID, Provider 이름, 사용된 토큰 수, 비용을 기록하여 데이터베이스에 저장합니다. getMonthlyUsage 메서드는 현재 월의 1일부터 오늘까지의 사용량을 집계하여 총 토큰 수와 총 비용을 반환합니다.

### 사용량 제한 (선택)

월간 사용 횟수를 조회한 후, 1000회를 초과하면 에러를 발생시켜 추가 호출을 막습니다.

---

## 에러 처리

### Retry 로직

retryAICall이라는 유틸리티 함수를 제공합니다. AI 호출이 실패하면 지수 백오프(1초 → 2초 → 4초) 간격으로 최대 3회까지 재시도합니다. 모든 재시도가 실패하면 마지막 에러를 발생시킵니다.

### Fallback

AI 요약 생성을 시도한 후, 성공하면 AI의 결과를 반환합니다. 실패하면 에러를 로깅하고 AI 없이 기본 통계만 정리하여 반환합니다.

---

## 캐싱

### 결과 캐싱

캐시 키를 사용자 ID와 월간 정보로 구성합니다. 먼저 해당 키의 캐시가 있는지 확인하고, 있으면 캐시된 결과를 바로 반환합니다. 없으면 AI를 호출하여 요약을 생성한 후, 결과를 1시간 동안 캐시에 저장하고 반환합니다.

---

## 프롬프트 관리

### 템플릿 시스템

프롬프트를 템플릿 형태로 관리하는 객체를 정의합니다. monthlySummary 템플릿은 Stats 객체를 받아 총 수입, 총 지출, 순액, 카테고리별 지출을 정리한 후 주요 인사이트를 3~5문장으로 작성하는 것을 요청하는 프롬프트를 생성합니다. receiptOCR 템플릿은 영수증 이미지에서 상호명, 금액, 날짜, 구매 항목을 JSON 형식으로 추출하는 프롬프트를 생성합니다.

---

## 보안

### API Key 보호

- 암호화하여 DB 저장
- 환경 변수로 관리 (선택)
- 프론트엔드에 절대 노출 금지

### Rate Limiting

AI API 호출에 속도 제한을 적용합니다. 1분 단위로 최대 10회까지만 요청을 허용하고, 그 이상이면 'Too many AI requests' 메시지로 요청을 막습니다. 이 미들웨어는 /api/ai/ 경로의 모든 요청에 적용됩니다.

---

## 사용자 제어

### AI 끄기

사용자가 언제든지 AI 기능을 비활성화할 수 있습니다. 해당 사용자의 AI 설정에서 provider를 'none'으로 업데이트하면 됩니다.

AI가 비활성화되면 모든 AI 기능은 기본 통계로 대체됩니다.